<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NSK Lag</title>

  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#111;
      --muted:#666;
      --line:#e7e7e7;
      --btn:#111;
      --btnText:#fff;
      --ghost:#f4f4f4;
      --ghostText:#111;
      --danger:#b00020;
      --ok:#0b7a0b;
      --radius:14px;
    }
    *{ box-sizing:border-box; }
    body{ margin:14px; font-family:-apple-system, system-ui, Segoe UI, Roboto, Arial; color:var(--text); background:var(--bg); }
    .nsk-top{ display:flex; align-items:center; gap:12px; margin: 6px 0 12px; }
    .nsk-logo{ width:56px; height:56px; border-radius:var(--radius); object-fit:cover; border:1px solid var(--line); background:#fff; }
    h1{ margin:0; font-size:22px; }
    .small{ font-size:12px; color:var(--muted); }
    .card{ border:1px solid var(--line); border-radius:var(--radius); padding:12px; margin:12px 0; background:var(--card); }
    label{ display:block; font-size:12px; color:var(--muted); margin: 0 0 6px; }
    select, input{ width:100%; padding:10px; border-radius:12px; border:1px solid #ccc; background:#fff; color:var(--text); outline:none; }
    input::placeholder{ color:#9a9a9a; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex: 1 1 160px; }
    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; }
    button{ padding:12px 14px; border-radius:12px; border:0; background:var(--btn); color:var(--btnText); font-weight:700; cursor:pointer; -webkit-tap-highlight-color: transparent; }
    button:active{ transform: translateY(1px); }
    button.ghost{ background:var(--ghost); color:var(--ghostText); border:1px solid var(--line); font-weight:700; }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; background:#f6f6f6; border:1px solid var(--line); font-size:12px; color:var(--muted); }
    .error{ color:var(--danger); font-weight:700; }
    .ok{ color:var(--ok); font-weight:700; }
    hr{ border:0; border-top:1px solid var(--line); margin:10px 0; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ border-bottom:1px solid #eee; padding:8px 6px; text-align:left; font-size:14px; vertical-align:top; }
    th{ font-size:12px; color:var(--muted); font-weight:700; }
    .nowrap{ white-space:nowrap; }
    .matchBlock{ break-inside: avoid; page-break-inside: avoid; }
    .hint{ font-size:12px; color:var(--muted); margin-top:6px; }

    /* Modals */
    #registerModal, #goalieStatsModal, #pdfModal{
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.52);
      padding:14px; z-index:9999;
    }
    .modalPanel{ background:#fff; border-radius:var(--radius); padding:12px; max-width:980px; margin:0 auto; max-height:90vh; overflow:auto; border:1px solid var(--line); }
    .modalHeader{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px; }
    .listItem{ display:flex; justify-content:space-between; align-items:center; gap:10px; border-bottom:1px solid #eee; padding:8px 0; }
    .listItem:last-child{ border-bottom:0; }
    .twoCols{ display:flex; gap:12px; flex-wrap:wrap; }
    .twoCols > .card{ flex: 1 1 360px; }

    /* Print/PDF */
    @media print{
      .no-print{ display:none !important; }
      body{ margin:0; }
      .card{ border:none; margin:0; padding:0; }
      .print-card{ border:1px solid var(--line) !important; padding:6px !important; border-radius: 12px !important; }
      .nsk-top{ margin:0 0 6px; }
      .nsk-logo{ width:44px; height:44px; }

      /* 4 per sida (2x2) */
      .printPage{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:4px;
        padding:4px;
        page-break-after: always;
      }
      .printPage:last-child{ page-break-after: auto; }
      .printPage .matchBlock{ margin:0 !important; }

      /* g√∂r tabellen kompakt s√• 4 matcher f√•r plats */
      th, td{ font-size:11px !important; padding:4px 4px !important; }
      th{ font-size:10px !important; }
      .small{ font-size:10px !important; }

/* Extra kompakt f√∂r A4 (s√• 4 matcher ryms p√• 1 sida) */
body[data-pdf="A4"] .printPage{
  gap:4px;
  padding:4px;
  transform: scale(0.82);
  transform-origin: top left;
  width: 121.95%;
}
body[data-pdf="A4"] .print-card{
  padding:4px !important;
  border-radius:10px !important;
}
body[data-pdf="A4"] hr{ display:none !important; }
body[data-pdf="A4"] b{ line-height:1.05; }
body[data-pdf="A4"] .small{ font-size:8px !important; line-height:1.05 !important; }
body[data-pdf="A4"] table{ width:100%; }
body[data-pdf="A4"] th, body[data-pdf="A4"] td{
  font-size:9px !important;
  padding:2px 2px !important;
  line-height:1.05 !important;
}
body[data-pdf="A4"] th{ font-size:8px !important; }
}
  </style>

  <!-- Dynamisk @page (A4/A3 landscape) s√§tts av JS -->
  <style id="pageStyle"></style>
</head>

<body>
  <div class="nsk-top">
    <img class="nsk-logo" src="./icon-192.png" alt="NSK">
    <div>
      <h1>NSK Lag</h1>
      <div class="small">Matchinfo ‚Ä¢ Laguppst√§llning ‚Ä¢ Byten ‚Ä¢ PDF</div>
    </div>
  </div>

  <!-- TOPP: LAG + MATCHINFO -->
  <div class="card no-print">
    <div class="row">
      <div>
        <label>Lag</label>
        <select id="teamSelect">
          <option value="1">Lag 1</option>
          <option value="2">Lag 2</option>
          <option value="3">Lag 3</option>
        </select>
      </div>

      <div>
        <label>Antal matcher</label>
        <select id="matchCount"></select>
      </div>

      <div>
        <label>Match</label>
        <select id="matchNo"></select>
      </div>

      <div>
        <label>Datum</label>
        <input id="matchDate" type="date">
      </div>

      <div>
        <label>Starttid</label>
        <input id="matchTime" type="time">
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>Motst√•ndare</label>
        <input id="opponent" placeholder="Skriv motst√•ndare">
      </div>
      <div>
        <label>Plan</label>
        <select id="arena"></select>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>Antal i laget</label>
        <select id="teamSize"></select>
      </div>
      <div>
        <label>Antal p√• plan</label>
        <select id="onCourt"></select>
      </div>
      <div>
        <label>Perioder per match</label>
        <select id="periodsCount"></select>
      </div>
      <div>
        <label>Periodtid (min)</label>
        <select id="periodMin"></select>
      </div>
      <div>
        <label>Bytestid (sek)</label>
        <select id="shiftSec"></select>
      </div>
    </div>

    <div style="margin-top:10px;" class="small">
      Allt sparas automatiskt per lag + match.
      <span id="saveState" class="pill" style="margin-left:8px;">Redo</span>
    </div>
  </div>

  <!-- LAGUPPST√ÑLLNING -->
  <div class="card no-print">
    <b>Spelare (denna match)</b>
    <div id="playersContainer" class="row" style="margin-top:10px;"></div>
    <div class="hint">Spelare 1 √§r b√§st, spelare 2 n√§st b√§st osv (anv√§nds i bytestipsen).</div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>M√•lvakt</label>
        <select id="goalie"></select>
      </div>
      <div>
        <label>Tr√§nare (samma f√∂r alla matcher i laget)</label>
        <select id="coach" multiple></select>
        <div class="hint">Tips: Markera flera genom att trycka flera g√•nger (mobil) / Ctrl/‚åò (dator).</div>
      </div>
    </div>

    <div id="msg" class="small" style="margin-top:10px;"></div>

    <div class="btnrow no-print" style="margin-top:12px;">
      <button onclick="renderAll()">Skapa matchblad</button>
      <button class="ghost" onclick="openPdfModal()">Dela PDF</button>
      <button class="ghost" onclick="openGoalieStats()">Statistik m√•lvakter</button>
      <button class="ghost" onclick="openRegister()">Truppen team 18</button>
      <button class="ghost" onclick="clearTeamMatch()">Rensa (lag+match)</button>
    </div>
  </div>

  <!-- OUTPUT / MATCHBLAD (PRINT-V√ÑNLIGT) -->
  <div class="card print-card" id="output">
    <b>Matchblad</b>
    <div class="small">Fyll i och tryck ‚ÄúSkapa matchblad‚Äù.</div>
  </div>

  <!-- PDF MODAL -->
  <div id="pdfModal" class="no-print">
    <div class="modalPanel">
      <div class="modalHeader">
        <b>Dela PDF</b>
        <button class="ghost" onclick="closePdfModal()">St√§ng</button>
      </div>

      <div class="card" style="margin:0;">
        <div class="small" style="margin-bottom:8px;">
          V√§lj pappersstorlek (liggande). Utskrift g√∂r 2√ó2 rutor = upp till 4 matchblad per sida.
        </div>

        <div class="row" style="margin-top:6px;">
          <div>
            <label>Pappersstorlek</label>
            <select id="pdfSize">
              <option value="A4">A4 (liggande)</option>
              <option value="A3">A3 (liggande)</option>
            </select>
            <div class="hint">Sparas i telefonen.</div>
          </div>
          <div style="display:flex; align-items:flex-end;">
            <button onclick="exportPDF()">Skapa PDF/Print</button>
          </div>
        </div>

        <div class="small" style="margin-top:10px;">
          üìÑ iPhone: Tryck <b>Skriv ut</b> ‚Üí nyp ut p√• f√∂rhandsvisningen ‚Üí <b>Dela</b> PDF.<br>
          üìÑ Android/Chrome: V√§lj <b>Spara som PDF</b>.
        </div>
      </div>
    </div>
  </div>

  <!-- GOALIE STATS MODAL -->
  <div id="goalieStatsModal" class="no-print">
    <div class="modalPanel">
      <div class="modalHeader">
        <b>Statistik m√•lvakter</b>
        <button class="ghost" onclick="closeGoalieStats()">St√§ng</button>
      </div>
      <div class="card" style="margin:0;">
        <div class="small" style="margin-bottom:8px;">
          Visar antal matcher d√§r en spelare varit vald som m√•lvakt (sparas i telefonen, per lag).
        </div>
        <div id="goalieStatsBody"></div>
      </div>
    </div>
  </div>

  <!-- REGISTER MODAL -->
  <div id="registerModal" class="no-print">
    <div class="modalPanel">
      <div class="modalHeader">
        <b>Truppen team 18</b>
        <button class="ghost" onclick="closeRegister()">St√§ng</button>
      </div>

      <div class="twoCols">
        <div class="card" style="margin:0;">
          <b>Spelare</b>
          <div class="row" style="margin-top:10px;">
            <input id="newPlayer" placeholder="F√∂rnamn Efternamn">
            <button onclick="addPlayer()">L√§gg till</button>
          </div>
          <div id="playerList" style="margin-top:10px;"></div>
          <div class="small" style="margin-top:8px;">Sorteras A‚Äì√ñ. Sparas i telefonen.</div>
        </div>

        <div class="card" style="margin:0;">
          <b>Tr√§nare</b>
          <div class="row" style="margin-top:10px;">
            <input id="newCoach" placeholder="F√∂rnamn Efternamn">
            <button onclick="addCoach()">L√§gg till</button>
          </div>
          <div id="coachList" style="margin-top:10px;"></div>
          <div class="small" style="margin-top:8px;">Sorteras A‚Äì√ñ. Sparas i telefonen.</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <b>Backup / Flytta till annan telefon</b>
        <div class="small" style="margin-top:6px;">
          Export/Import av register + alla lag/matcher + m√•lvaktsstatistik.
        </div>
        <div class="btnrow" style="margin-top:10px;">
          <button class="ghost" onclick="exportJSON()">Exportera JSON</button>
          <label style="margin:0; flex: 1 1 260px;">
            <span class="small">Importera JSON</span>
            <input id="importFile" type="file" accept="application/json" />
          </label>
        </div>
        <div id="importMsg" class="small" style="margin-top:8px;"></div>
      </div>

    </div>
  </div>

<script>
  // ----------------------------
  // Utilities
  // ----------------------------
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }
  function uniq(arr){
    const out = [];
    const seen = new Set();
    for (const x of arr){
      const v = (x || "").trim();
      if (!v) continue;
      const key = v.toLowerCase();
      if (seen.has(key)) continue;
      seen.add(key);
      out.push(v);
    }
    return out;
  }
  function setPill(text){
    const pill = document.getElementById("saveState");
    if (!pill) return;
    pill.textContent = text;
  }
  function safeParseJSON(raw, fallback){
    try { return JSON.parse(raw); } catch { return fallback; }
  }
  function selectedValues(selectEl){
    return Array.from(selectEl.selectedOptions || []).map(o => o.value).filter(Boolean);
  }

  // F√∂rnamn + f√∂rsta bokstaven i efternamn (t.ex. "August H")
  function shortName(full){
    const parts = String(full || "").trim().split(/\s+/).filter(Boolean);
    if (!parts.length) return "";
    if (parts.length === 1) return parts[0];
    const first = parts[0];
    const last = parts[parts.length - 1];
    const initial = last ? last[0].toUpperCase() : "";
    return initial ? `${first} ${initial}` : first;
  }

  // ----------------------------
  // PDF inst√§llningar
  // ----------------------------
  const PDF_PREF_KEY = "nsk_pdf_size";
  function loadPdfSize(){
    const v = (localStorage.getItem(PDF_PREF_KEY) || "A4").toUpperCase();
    return (v === "A3") ? "A3" : "A4";
  }
  function savePdfSize(v){
    localStorage.setItem(PDF_PREF_KEY, (v || "A4").toUpperCase());
  }
  function applyPageStyle(){
    const size = loadPdfSize();
    const css = `@page { size: ${size} landscape; margin: 10mm; }`;
    document.getElementById("pageStyle").textContent = css;
  }
  function openPdfModal(){
    document.getElementById("pdfModal").style.display = "block";
    document.getElementById("pdfSize").value = loadPdfSize();
  }
  function closePdfModal(){
    document.getElementById("pdfModal").style.display = "none";
  }

  // ----------------------------
  // M√•lvakts-statistik (per lag, persistent)
  // ----------------------------
  function goalieStatsKey(teamOverride=null){
    const team = teamOverride ?? (document.getElementById("teamSelect").value || "1");
    return `nsk_goalie_stats_team_${team}`;
  }
  function goalieCountedKey(teamNo, matchNo){
    return `nsk_goalie_counted_team_${teamNo}_match_${matchNo}`;
  }
  function loadGoalieStats(teamNo){
    const raw = localStorage.getItem(goalieStatsKey(String(teamNo)));
    const obj = raw ? safeParseJSON(raw, {}) : {};
    return (obj && typeof obj === "object") ? obj : {};
  }
  function saveGoalieStats(teamNo, obj){
    localStorage.setItem(goalieStatsKey(String(teamNo)), JSON.stringify(obj || {}));
  }
  function incGoalie(teamNo, playerLower, delta){
    if (!playerLower) return;
    const stats = loadGoalieStats(teamNo);
    const cur = parseInt(stats[playerLower] || "0", 10) || 0;
    const next = Math.max(0, cur + (delta || 0));
    if (next === 0) delete stats[playerLower];
    else stats[playerLower] = next;
    saveGoalieStats(teamNo, stats);
  }

  // Seed f√∂rsta g√•ngen fr√•n befintliga match-states, s√• att gamla val r√§knas.
  function ensureGoalieStatsSeeded(teamNo){
    const key = goalieStatsKey(String(teamNo));
    if (localStorage.getItem(key) != null) return;

    const stats = {};
    const rawCount = localStorage.getItem(`nsk_matchCount_team_${teamNo}`);
    const count = rawCount ? (parseInt(rawCount, 10) || 4) : 4;

    for (let m=1; m<=count; m++){
      const raw = localStorage.getItem(`nsk_state_team_${teamNo}_match_${m}`);
      const st = raw ? safeParseJSON(raw, {}) : {};
      const g = (st.goalie || "").trim();
      if (!g) continue;
      const gl = g.toLowerCase();
      stats[gl] = (parseInt(stats[gl] || "0", 10) || 0) + 1;
      localStorage.setItem(goalieCountedKey(String(teamNo), String(m)), gl);
    }
    localStorage.setItem(key, JSON.stringify(stats));
  }

  function updateGoalieStatsForMatch(teamNo, matchNo, currentGoalie){
    ensureGoalieStatsSeeded(teamNo);

    const countedK = goalieCountedKey(teamNo, matchNo);
    const currentLower = (currentGoalie || "").trim() ? currentGoalie.trim().toLowerCase() : "";
    const prevLower = (localStorage.getItem(countedK) || "").trim();

    if (prevLower === currentLower) return;

    if (prevLower) incGoalie(teamNo, prevLower, -1);

    if (currentLower) {
      incGoalie(teamNo, currentLower, +1);
      localStorage.setItem(countedK, currentLower);
    } else {
      localStorage.removeItem(countedK);
    }
  }

  function uncountGoalieFor(teamNo, matchNo){
    ensureGoalieStatsSeeded(teamNo);
    const countedK = goalieCountedKey(String(teamNo), String(matchNo));
    const prevLower = (localStorage.getItem(countedK) || "").trim();
    if (prevLower){
      incGoalie(String(teamNo), prevLower, -1);
      localStorage.removeItem(countedK);
    }
  }

  function openGoalieStats(){
    const teamNo = document.getElementById("teamSelect").value || "1";
    ensureGoalieStatsSeeded(teamNo);
    document.getElementById("goalieStatsModal").style.display = "block";
    renderGoalieStats();
  }
  function closeGoalieStats(){
    document.getElementById("goalieStatsModal").style.display = "none";
  }
  

function renderGoalieStats(){
  const teamSel = document.getElementById("teamSelect");
  const filterTeam = teamSel ? (teamSel.value || "1") : "1";

  const data = computeGoalieStats(filterTeam);
  const box = document.getElementById("goalieStatsTable");
  const msg = document.getElementById("goalieStatsMsg");

  if (!box) return;

  if (!data.length){
    box.innerHTML = "<div class='small'>Ingen m√•lvakt √§r vald i sparade matcher.</div>";
    if (msg) msg.innerHTML = "";
    return;
  }

  box.innerHTML = `
    <table>
      <thead><tr><th>Spelare</th><th class="nowrap">Matcher som m√•lvakt</th></tr></thead>
      <tbody>
        ${data.map(x=>`
          <tr>
            <td>${escapeHtml(x.name)}</td>
            <td class="nowrap">
              <input
                type="number"
                min="0"
                step="1"
                value="${x.n}"
                data-goalie-lower="${escapeHtml(x.lower)}"
                style="width:90px; padding:6px 8px; border-radius:10px; border:1px solid #ccc;"
              >
            </td>
          </tr>
        `).join("")}
      </tbody>
    </table>
    <div class="small" style="margin-top:8px;">
      √Ñndra antal manuellt. S√§tt <b>0</b> f√∂r att ta bort spelaren fr√•n listan.
    </div>
  `;

  const overrides = loadGoalieOverrides(filterTeam);

  box.querySelectorAll('input[data-goalie-lower]').forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const lower = (inp.getAttribute("data-goalie-lower") || "").toLowerCase();
      let v = parseInt(inp.value || "0", 10);
      if (!Number.isFinite(v)) v = 0;
      overrides[lower] = v; // 0 => removed in compute
      saveGoalieOverrides(filterTeam, overrides);
    });
    inp.addEventListener("change", ()=>{
      renderGoalieStats();
    });
  });

  if (msg){
    const label = (filterTeam === "all") ? "Alla lag" : `Lag ${filterTeam}`;
    msg.innerHTML = `<span class="pill">${escapeHtml(label)}</span>`;
  }
}


  // ----------------------------
  // "Match 1 -> √∂vriga matcher" (spelare + m√•lvakt) tills man manuellt √§ndrar
  // ----------------------------
  function manualKey(teamNo, matchNo){
    return `nsk_manual_team_${teamNo}_match_${matchNo}`;
  }
  function loadManualFlags(teamNo, matchNo){
    const raw = localStorage.getItem(manualKey(teamNo, matchNo));
    const obj = raw ? safeParseJSON(raw, {}) : {};
    return (obj && typeof obj === "object") ? obj : {};
  }
  function saveManualFlags(teamNo, matchNo, flags){
    localStorage.setItem(manualKey(teamNo, matchNo), JSON.stringify(flags || {}));
  }
  function markManual(teamNo, matchNo, field){
    const f = loadManualFlags(teamNo, matchNo);
    f[field] = true;
    saveManualFlags(teamNo, matchNo, f);
  }

  function getStateFor(teamNo, matchNo){
    const raw = localStorage.getItem(`nsk_state_team_${teamNo}_match_${matchNo}`);
    const st = raw ? safeParseJSON(raw, {}) : {};
    return Object.assign(defaultsState(), st || {});
  }
  function setStateFor(teamNo, matchNo, st){
    localStorage.setItem(`nsk_state_team_${teamNo}_match_${matchNo}`, JSON.stringify(st || {}));
  }

  function propagateFromMatch1(teamNo){
    const count = loadMatchCountForTeam(teamNo);
    const st1 = getStateFor(teamNo, 1);

    for (let m=2; m<=count; m++){
      const flags = loadManualFlags(teamNo, m);
      const st = getStateFor(teamNo, m);

      if (!flags.players){
        st.teamSize = st1.teamSize || st.teamSize;
        st.players = Array.isArray(st1.players) ? st1.players.slice() : st.players;
      }
      if (!flags.goalie){
        st.goalie = st1.goalie || st.goalie;
      }

      setStateFor(teamNo, m, st);

      if (!flags.goalie){
        updateGoalieStatsForMatch(String(teamNo), String(m), st.goalie || "");
      }
    }
  }

  function applyMatch1DefaultsIfNeeded(teamNo, matchNo, st){
    if (parseInt(matchNo,10) === 1) return st;
    const st1 = getStateFor(teamNo, 1);
    const flags = loadManualFlags(teamNo, matchNo);

    if (!flags.players){
      const hasPlayers = Array.isArray(st.players) && st.players.some(x => (x||"").trim());
      if (!hasPlayers){
        st.teamSize = st1.teamSize || st.teamSize;
        st.players = Array.isArray(st1.players) ? st1.players.slice() : st.players;
      }
    }
    if (!flags.goalie){
      if (!(st.goalie || "").trim() && (st1.goalie || "").trim()){
        st.goalie = st1.goalie;
      }
    }
    return st;
  }

  // ----------------------------
  // Default register data
  // ----------------------------
  const DEFAULT_PLAYERS = [
    "Alex Andersson","Benjamin Berg","Carl Carlsson","David Dahl",
    "Elias Eriksson","Filip Friberg","Gustav Gran","Hugo Holm"
  ];
  const DEFAULT_COACHES = ["Peter","Olle","Fredrik","Tommy"];

  function loadRegister(){
    const p = localStorage.getItem("nsk_players");
    const c = localStorage.getItem("nsk_coaches");
    let players = p ? safeParseJSON(p, DEFAULT_PLAYERS.slice()) : DEFAULT_PLAYERS.slice();
    let coaches = c ? safeParseJSON(c, DEFAULT_COACHES.slice()) : DEFAULT_COACHES.slice();
    players = uniq(players).sort((a,b)=>a.localeCompare(b,'sv'));
    coaches = uniq(coaches).sort((a,b)=>a.localeCompare(b,'sv'));
    return {players, coaches};
  }
  function saveRegister(players, coaches){
    localStorage.setItem("nsk_players", JSON.stringify(uniq(players).sort((a,b)=>a.localeCompare(b,'sv'))));
    localStorage.setItem("nsk_coaches", JSON.stringify(uniq(coaches).sort((a,b)=>a.localeCompare(b,'sv'))));
  }
  function fillSelect(el, items, placeholder="V√§lj..."){
    el.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder;
    el.appendChild(opt0);
    for (const name of items){
      const o = document.createElement("option");
      o.value = name;
      o.textContent = name;
      el.appendChild(o);
    }
  }
  function fillMultiSelect(el, items){
    el.innerHTML = "";
    for (const name of items){
      const o = document.createElement("option");
      o.value = name;
      o.textContent = name;
      el.appendChild(o);
    }
  }

  // ----------------------------
  // Antal matcher per lag
  // ----------------------------
  function matchCountKey(teamOverride=null){
    const team = teamOverride ?? (document.getElementById("teamSelect").value || "1");
    return `nsk_matchCount_team_${team}`;
  }
  function loadMatchCountForTeam(teamNo){
    const raw = localStorage.getItem(matchCountKey(String(teamNo)));
    const n = raw ? parseInt(raw, 10) : 4;
    return (Number.isFinite(n) && n >= 1 && n <= 30) ? n : 4;
  }
  function loadMatchCount(){
    return loadMatchCountForTeam(document.getElementById("teamSelect").value || "1");
  }
  function saveMatchCount(n){
    const team = document.getElementById("teamSelect").value || "1";
    localStorage.setItem(matchCountKey(team), String(n));
  }
  function fillMatchCountDropdown(){
    const sel = document.getElementById("matchCount");
    sel.innerHTML = "";
    for (let i=1; i<=30; i++){
      const o = document.createElement("option");
      o.value = String(i);
      o.textContent = String(i);
      sel.appendChild(o);
    }
  }
  function applyMatchCount(){
    const count = loadMatchCount();
    document.getElementById("matchCount").value = String(count);

    const matchNoSel = document.getElementById("matchNo");
    const current = parseInt(matchNoSel.value || "1", 10);
    matchNoSel.innerHTML = "";
    for (let i=1; i<=count; i++){
      const o = document.createElement("option");
      o.value = String(i);
      o.textContent = `Match ${i}`;
      matchNoSel.appendChild(o);
    }
    matchNoSel.value = String(Math.min(Math.max(current || 1, 1), count));
  }

  // ----------------------------
  // Coach per TEAM
  // ----------------------------
  function teamCoachKey(teamOverride=null){
    const team = teamOverride ?? (document.getElementById("teamSelect").value || "1");
    return `nsk_team_coaches_team_${team}`;
  }
  function loadTeamCoaches(){
    const raw = localStorage.getItem(teamCoachKey());
    const arr = raw ? safeParseJSON(raw, []) : [];
    return Array.isArray(arr) ? arr : [];
  }
  function saveTeamCoaches(values){
    localStorage.setItem(teamCoachKey(), JSON.stringify(uniq(values)));
  }
  function applyTeamCoachesToUI(){
    const coachSel = document.getElementById("coach");
    const chosen = new Set(loadTeamCoaches().map(x=>String(x).toLowerCase()));
    for (const opt of coachSel.options){
      opt.selected = chosen.has(String(opt.value).toLowerCase());
    }
  }

  // ----------------------------
  // Per (lag + match) state
  // ----------------------------
  function stateKey(teamOverride=null, matchOverride=null){
    const team = teamOverride ?? (document.getElementById("teamSelect").value || "1");
    const matchNo = matchOverride ?? (document.getElementById("matchNo").value || "1");
    return `nsk_state_team_${team}_match_${matchNo}`;
  }
  function defaultsState(){
    return {
      matchDate: "",
      matchTime: "",
      opponent: "",
      arena: "1",
      teamSize: "10",
      onCourt: "3",
      periodsCount: "1",
      periodMin: "15",
      shiftSec: "90",
      players: [],
      goalie: ""
    };
  }

  function getFormState(){
    const teamSize = document.getElementById("teamSize").value || "10";
    const players = [];
    for (let i=1; i<=parseInt(teamSize,10); i++){
      const sel = document.getElementById(`p${i}`);
      players.push(sel ? (sel.value || "") : "");
    }
    return {
      matchDate: document.getElementById("matchDate").value || "",
      matchTime: document.getElementById("matchTime").value || "",
      opponent: document.getElementById("opponent").value || "",
      arena: document.getElementById("arena").value || "1",
      teamSize: teamSize,
      onCourt: document.getElementById("onCourt").value || "3",
      periodsCount: document.getElementById("periodsCount").value || "1",
      periodMin: document.getElementById("periodMin").value || "15",
      shiftSec: document.getElementById("shiftSec").value || "90",
      players: players,
      goalie: document.getElementById("goalie").value || ""
    };
  }

  function setFormState(s){
    const d = Object.assign(defaultsState(), s || {});
    document.getElementById("matchDate").value = d.matchDate || "";
    document.getElementById("matchTime").value = d.matchTime || "";
    document.getElementById("opponent").value = d.opponent || "";
    document.getElementById("arena").value = d.arena || "1";
    document.getElementById("teamSize").value = d.teamSize || "10";
    document.getElementById("onCourt").value = d.onCourt || "3";
    document.getElementById("periodsCount").value = d.periodsCount || "1";
    document.getElementById("periodMin").value = d.periodMin || "15";
    document.getElementById("shiftSec").value = d.shiftSec || "90";

    renderPlayerSelectors(parseInt(d.teamSize,10) || 10, Array.isArray(d.players) ? d.players : []);
    document.getElementById("goalie").value = d.goalie || "";
  }

  function saveState(){
    localStorage.setItem(stateKey(), JSON.stringify(getFormState()));
    setPill("Sparat");
    window.clearTimeout(window.__savePillTimer);
    window.__savePillTimer = window.setTimeout(()=>setPill("Redo"), 700);
  }

  function loadState(){
    const teamNo = document.getElementById("teamSelect").value || "1";
    const matchNo = document.getElementById("matchNo").value || "1";

    const raw = localStorage.getItem(stateKey());
    let st = raw ? safeParseJSON(raw, {}) : {};
    st = Object.assign(defaultsState(), st || {});
    st = applyMatch1DefaultsIfNeeded(String(teamNo), String(matchNo), st);

    setFormState(st);
    document.getElementById("msg").innerHTML = "";
  }

  function clearTeamMatch(){
    const teamNo = document.getElementById("teamSelect").value || "1";
    const matchNo = document.getElementById("matchNo").value || "1";

    // ta bort m√•lvakt fr√•n statistiken f√∂r denna match
    uncountGoalieFor(teamNo, matchNo);

    localStorage.removeItem(stateKey());
    loadState();
    renderAll();

    if (document.getElementById("goalieStatsModal").style.display === "block"){
      renderGoalieStats();
    }
  }

  function loadStateFor(teamNo, matchNo){
    const raw = localStorage.getItem(stateKey(String(teamNo), String(matchNo)));
    let st = raw ? safeParseJSON(raw, {}) : {};
    st = Object.assign(defaultsState(), st || {});
    st = applyMatch1DefaultsIfNeeded(String(teamNo), String(matchNo), st);
    return st;
  }

  // ----------------------------
  // Dynamic player selectors (Spelare 1..N)
  // ----------------------------
  function renderPlayerSelectors(n, values){
    const {players} = loadRegister();
    const container = document.getElementById("playersContainer");
    container.innerHTML = "";

    const wanted = Math.min(25, Math.max(1, parseInt(n,10) || 1));
    const vals = Array.isArray(values) ? values.slice(0, wanted) : [];
    while (vals.length < wanted) vals.push("");

    for (let i=1; i<=wanted; i++){
      const wrap = document.createElement("div");
      const lab = document.createElement("label");
      lab.textContent = `Spelare ${i}`;
      const sel = document.createElement("select");
      sel.id = `p${i}`;

      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "V√§lj...";
      sel.appendChild(opt0);
      for (const name of players){
        const o = document.createElement("option");
        o.value = name;
        o.textContent = name;
        sel.appendChild(o);
      }

      sel.value = vals[i-1] || "";

      sel.addEventListener("change", ()=>{
        const teamNo = document.getElementById("teamSelect").value || "1";
        const matchNo = document.getElementById("matchNo").value || "1";

        if (parseInt(matchNo,10) > 1) markManual(teamNo, matchNo, "players");

        saveState();

        if (parseInt(matchNo,10) === 1){
          propagateFromMatch1(teamNo);
        }

        renderAll();
      });

      wrap.appendChild(lab);
      wrap.appendChild(sel);
      container.appendChild(wrap);
    }
  }

  // ----------------------------
  // Validation
  // ----------------------------
  function validateCurrentMatch(){
    const s = getFormState();
    const chosen = (s.players || []).map(x=>(x||"").trim()).filter(Boolean);
    const set = new Set(chosen.map(x=>x.toLowerCase()));
    if (set.size !== chosen.length) return "Samma spelare √§r vald flera g√•nger.";
    if (s.goalie && set.has(s.goalie.toLowerCase())) return "M√•lvakt kan inte vara utespelare.";
    const onCourt = Math.min(5, Math.max(3, parseInt(s.onCourt,10) || 3));
    if (chosen.length && chosen.length < onCourt) return `F√∂r f√• spelare valda. Antal p√• plan √§r ${onCourt}.`;
    return "";
  }

  // ----------------------------
  // Bytesschema times (utan 00:00)
  // ----------------------------
  function formatMMSS(totalSeconds){
    const s = Math.max(0, Math.floor(totalSeconds));
    const mm = String(Math.floor(s/60)).padStart(2,"0");
    const ss = String(s%60).padStart(2,"0");
    return `${mm}:${ss}`;
  }
  function buildShiftTimes(totalMinutes, shiftSec){
    const totalSeconds = Math.floor(totalMinutes * 60);
    const step = Math.max(1, Math.floor(shiftSec));
    const times = [];
    for (let t = totalSeconds; t > 0; t -= step){
      times.push(formatMMSS(t));
    }
    return [...new Set(times)];
  }

  // ----------------------------
  // Rotation helpers
  // ----------------------------
  function rosterFromState(st){
    const raw = (st.players || []).map(x=>(x||"").trim()).filter(Boolean);
    const out = [];
    const seen = new Set();
    for (const n of raw){
      const k = n.toLowerCase();
      if (seen.has(k)) continue;
      seen.add(k);
      out.push(n);
    }
    return out;
  }
  function makeRatings(roster){
    const r = {};
    const n = roster.length;
    for (let i=0; i<n; i++){
      r[roster[i].toLowerCase()] = (n - i); // spelare 1 h√∂gst
    }
    return r;
  }
  function countOverlap(a, b){
    const setA = new Set((a||[]).map(x=>x.toLowerCase()));
    let o = 0;
    for (const x of (b||[])){
      if (setA.has(x.toLowerCase())) o++;
    }
    return o;
  }

  // ----------------------------
  // Bytesschema:
  // - Undvik samma spelare tv√• byten i rad s√• l√•ngt det g√•r
  // - Om roster >= 2*k och vi har prev => kr√§va overlap == 0 (ingen f√•r spela tv√• byten i rad)
  // ----------------------------
  function makeLineupsForMatch(st, globalCounts, shiftTimes){
    const roster = rosterFromState(st);
    const kWanted = Math.min(Math.max(3, parseInt(st.onCourt,10) || 3), 5);
    const k = Math.min(kWanted, roster.length || kWanted);

    const ratings = makeRatings(roster);

    for (const n of roster){
      const key = n.toLowerCase();
      if (globalCounts[key] == null) globalCounts[key] = 0;
    }

    if (!roster.length){
      return shiftTimes.map(()=>[]);
    }

    const W_FAIR = 10;  // j√§mn speltid
    const W_STR  = 3;   // styrka
    const W_REST = 40;  // straff f√∂r overlap (n√•gon spelar tv√• byten i rad)

    let prev = null;
    const lineups = [];

    for (let i=0; i<shiftTimes.length; i++){
      const countsArr = roster.map(n => ({n, c: globalCounts[n.toLowerCase()]||0, r: ratings[n.toLowerCase()]||0}));
      countsArr.sort((a,b)=>{
        if (a.c !== b.c) return a.c - b.c;
        return b.r - a.r;
      });

      const poolSet = new Set();
      const pool = [];

      for (const obj of countsArr.slice(0, Math.min(14, roster.length))){
        const key = obj.n.toLowerCase();
        if (!poolSet.has(key)){ poolSet.add(key); pool.push(obj.n); }
      }
      const strongArr = countsArr.slice().sort((a,b)=>b.r - a.r);
      for (const obj of strongArr.slice(0, Math.min(10, roster.length))){
        const key = obj.n.toLowerCase();
        if (!poolSet.has(key)){ poolSet.add(key); pool.push(obj.n); }
      }

      // s√§kerst√§ll att vi kan v√§lja k
      if (pool.length < k){
        for (const n of roster){
          const key = n.toLowerCase();
          if (!poolSet.has(key)){ poolSet.add(key); pool.push(n); }
          if (pool.length >= k) break;
        }
      }

      const M = Math.min(pool.length, 14);
      const P = pool.slice(0, M);

      const candidates = [];
      const idxs = [];
      function rec(start, left){
        if (left === 0){
          const lineup = idxs.map(j => P[j]);

          const minC = Math.min(...roster.map(n=>globalCounts[n.toLowerCase()]||0));
          let fairPenalty = 0;
          let strength = 0;
          for (const n of lineup){
            const key = n.toLowerCase();
            fairPenalty += (globalCounts[key] || 0) - minC;
            strength += (ratings[key] || 0);
          }
          const fairScore = -fairPenalty;

          const overlap = prev ? countOverlap(prev, lineup) : 0;
          const restPenalty = -W_REST * overlap;

          const score = W_FAIR * fairScore + W_STR * strength + restPenalty;

          candidates.push({lineup, score, overlap});
          return;
        }
        for (let j=start; j<=M-left; j++){
          idxs.push(j);
          rec(j+1, left-1);
          idxs.pop();
        }
      }
      rec(0, k);

      // om vi kan (minst 2*k spelare) => inga tv√• byten i rad
      let allowed = candidates;
      if (prev && roster.length >= 2 * k){
        const zero = candidates.filter(x => x.overlap === 0);
        if (zero.length) allowed = zero;
      }

      allowed.sort((x,y)=>{
        if (y.score !== x.score) return y.score - x.score;
        if (x.overlap !== y.overlap) return x.overlap - y.overlap;
        return 0;
      });

      const best = allowed.length ? allowed[0].lineup : [];

      for (const n of best){
        const key = n.toLowerCase();
        globalCounts[key] = (globalCounts[key] || 0) + 1;
      }

      lineups.push(best);
      prev = best;
    }

    return lineups;
  }

  function lineupToShortText(names){
    return (names || []).map(shortName).filter(Boolean).join(", ") || "‚Äî";
  }

  function formatInfoLine(st){
    const date = st.matchDate || "‚Äî";
    const time = st.matchTime || "‚Äî";
    const opp  = st.opponent || "‚Äî";
    // Plan visas som bara 1-4
    return `Datum: <b>${escapeHtml(date)}</b> ‚Ä¢ Start: <b>${escapeHtml(time)}</b><br>
            Motst√•ndare: <b>${escapeHtml(opp)}</b> ‚Ä¢ Plan: <b>${escapeHtml(st.arena || "‚Äî")}</b>`;
  }

  // PDF-krav:
  // - Ta bort raden "Antal i laget... Perioder... Bytestid..."
  // - Ta bort avsnittet "Laguppst√§llning (ranking)..."
  // - Ta bort text "h√•rd vila-regel"
  // - Ta bort f√∂rklarande text under tabellen
function renderMatchBlock(teamNo, matchNo, st, shiftTimes, lineups){
  const coaches = loadTeamCoaches();
  const coachText = coaches.length ? coaches.join(", ") : "‚Äî";
  const goalie = (st.goalie || "").trim() || "‚Äî";

  return `
    <div class="print-card matchBlock">
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-end;flex-wrap:wrap;">
        <div><b>Match ${escapeHtml(matchNo)} ‚Ä¢ Lag ${escapeHtml(teamNo)}</b></div>
        <div class="small">${formatInfoLine(st)}</div>
      </div>

      <hr>

      <!-- Tr√§nare + M√•lvakt (inte i bytesschemat) -->
      <div class="small" style="margin-bottom:6px;">
        <div><b>Tr√§nare:</b> ${escapeHtml(coachText)}</div>
        <div><b>M√•lvakt:</b> ${escapeHtml(goalie)}</div>
      </div>

      <div>
        <div><b>Bytesschema</b></div>
        <table>
          <thead><tr><th>#</th><th>Tid kvar</th><th>P√• plan</th></tr></thead>
          <tbody>
            ${shiftTimes.map((t,i)=>`
              <tr>
                <td>${i+1}</td>
                <td class="nowrap">${escapeHtml(t)}</td>
                <td>${escapeHtml(lineupToShortText(lineups[i] || []))}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

  // ----------------------------
  // Render ALLA matcher (1..matchCount) f√∂r valt lag
  // - packa 4 matchBlock per sida (printPage)
  // ----------------------------
  function renderAll(){
    const err = validateCurrentMatch();
    const msg = document.getElementById("msg");
    msg.innerHTML = err
      ? `<span class="error">‚úñ ${escapeHtml(err)}</span>`
      : `<span class="ok">‚úî OK</span> <span class="small">Inga dubbletter.</span>`;

    const teamNo = document.getElementById("teamSelect").value || "1";
    const matchCount = loadMatchCount();

    const globalCounts = {};
    const blocks = [];

    for (let m=1; m<=matchCount; m++){
      const st = loadStateFor(teamNo, m);

      const periodsCount = Math.min(3, Math.max(1, parseInt(st.periodsCount, 10) || 1));
      const periodMin = parseInt(st.periodMin, 10) || 15;
      const shiftSec = parseInt(st.shiftSec, 10) || 90;

      const totalMinutes = periodMin * periodsCount;
      const shiftTimes = buildShiftTimes(totalMinutes, shiftSec);

      const lineups = makeLineupsForMatch(st, globalCounts, shiftTimes);

      blocks.push(renderMatchBlock(teamNo, m, st, shiftTimes, lineups));
    }

    let html = "";
    for (let i=0; i<blocks.length; i+=4){
      html += `<div class="printPage">${blocks.slice(i, i+4).join("")}</div>`;
    }

    document.getElementById("output").innerHTML = html || "<b>Matchblad</b><div class='small'>Inga matcher.</div>";
  }

  function exportPDF(){
    const sel = document.getElementById("pdfSize");
    const chosen = (sel && sel.value) ? sel.value : loadPdfSize();
    savePdfSize(chosen);
    applyPageStyle();

    closePdfModal();
    renderAll();
    window.print();
  }

  // ----------------------------
  // Register modal
  // ----------------------------
  function openRegister(){
    document.getElementById("registerModal").style.display = "block";
    renderRegisterLists();
  }
  function closeRegister(){
    document.getElementById("registerModal").style.display = "none";
  }

  function renderRegisterLists(){
    const {players, coaches} = loadRegister();

    const pl = document.getElementById("playerList");
    pl.innerHTML = players.map((n,i)=>`
      <div class="listItem">
        <div>${escapeHtml(n)}</div>
        <div style="display:flex; gap:4px;">
          <button class="ghost" onclick="editPlayer(${i})">Redigera</button>
          <button class="ghost" onclick="removePlayer(${i})">Ta bort</button>
        </div>
      </div>
    `).join("") || "<div class='small'>Inga spelare i registret.</div>";

    const cl = document.getElementById("coachList");
    cl.innerHTML = coaches.map((n,i)=>`
      <div class="listItem">
        <div>${escapeHtml(n)}</div>
        <div style="display:flex; gap:4px;">
          <button class="ghost" onclick="editCoach(${i})">Redigera</button>
          <button class="ghost" onclick="removeCoach(${i})">Ta bort</button>
        </div>
      </div>
    `).join("") || "<div class='small'>Inga tr√§nare i registret.</div>";
  }

  function addPlayer(){
    const inp = document.getElementById("newPlayer");
    const name = (inp.value||"").trim();
    if (!name) return;
    const {players, coaches} = loadRegister();
    players.push(name);
    saveRegister(players, coaches);
    inp.value = "";
    renderRegisterLists();
    refreshAllDropdownsAndPlayers();
    renderAll();
  }

  function addCoach(){
    const inp = document.getElementById("newCoach");
    const name = (inp.value||"").trim();
    if (!name) return;
    const {players, coaches} = loadRegister();
    coaches.push(name);
    saveRegister(players, coaches);
    inp.value = "";
    renderRegisterLists();
    refreshAllDropdownsAndPlayers();
    renderAll();
  }

  function removePlayer(idx){
    const {players, coaches} = loadRegister();
    players.splice(idx, 1);
    saveRegister(players, coaches);
    renderRegisterLists();
    refreshAllDropdownsAndPlayers();
    renderAll();
  }

  function removeCoach(idx){
    const {players, coaches} = loadRegister();
    coaches.splice(idx, 1);
    saveRegister(players, coaches);
    renderRegisterLists();
    refreshAllDropdownsAndPlayers();
    renderAll();
  }

  function editPlayer(idx){
    const {players, coaches} = loadRegister();
    const current = players[idx];
    const next = prompt("Redigera spelare:", current || "");
    if (next == null) return;
    const name = String(next).trim();
    if (!name) return;
    players[idx] = name;
    saveRegister(players, coaches);
    renderRegisterLists();
    refreshAllDropdownsAndPlayers();
    renderAll();
  }

  function editCoach(idx){
    const {players, coaches} = loadRegister();
    const current = coaches[idx];
    const next = prompt("Redigera tr√§nare:", current || "");
    if (next == null) return;
    const name = String(next).trim();
    if (!name) return;

    coaches[idx] = name;

    const oldLower = String(current || "").toLowerCase();
    const selected = loadTeamCoaches();
    const updated = selected.map(x => (String(x).toLowerCase() === oldLower ? name : x));

    saveRegister(players, coaches);
    saveTeamCoaches(updated);

    renderRegisterLists();
    refreshAllDropdownsAndPlayers();
    applyTeamCoachesToUI();
    renderAll();
  }

  function refreshAllDropdownsAndPlayers(){
    const {players, coaches} = loadRegister();

    // goalie
    const goalieSel = document.getElementById("goalie");
    const currentGoalie = goalieSel.value;
    fillSelect(goalieSel, players, "V√§lj...");
    goalieSel.value = currentGoalie;

    // coaches multi
    const coachSel = document.getElementById("coach");
    const currentTeamCoaches = loadTeamCoaches();
    fillMultiSelect(coachSel, coaches);
    const chosen = new Set(currentTeamCoaches.map(x=>String(x).toLowerCase()));
    for (const opt of coachSel.options){
      opt.selected = chosen.has(String(opt.value).toLowerCase());
    }

    // players container (beh√•ll val)
    const st = getFormState();
    renderPlayerSelectors(parseInt(st.teamSize,10)||10, st.players || []);
  }

  // ----------------------------
  // Backup
  // ----------------------------
  function exportJSON(){
    const payload = {
      players: loadRegister().players,
      coaches: loadRegister().coaches,
      matchCounts: {},
      teamCoaches: {},
      states: {},
      goalieStats: {},
      goalieCounted: {},
      manualFlags: {},
      pdfPrefs: { [PDF_PREF_KEY]: loadPdfSize() }
    };

    for (let t=1; t<=3; t++){
      const kCount = `nsk_matchCount_team_${t}`;
      if (localStorage.getItem(kCount) != null){
        payload.matchCounts[kCount] = localStorage.getItem(kCount);
      }
      const kCoach = `nsk_team_coaches_team_${t}`;
      if (localStorage.getItem(kCoach) != null){
        payload.teamCoaches[kCoach] = safeParseJSON(localStorage.getItem(kCoach) || "[]", []);
      }
      const kGs = `nsk_goalie_stats_team_${t}`;
      if (localStorage.getItem(kGs) != null){
        payload.goalieStats[kGs] = safeParseJSON(localStorage.getItem(kGs) || "{}", {});
      }
    }

    for (let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      if (!k) continue;

      if (k.startsWith("nsk_state_")){
        payload.states[k] = safeParseJSON(localStorage.getItem(k) || "{}", {});
      }
      if (k.startsWith("nsk_goalie_counted_team_")){
        payload.goalieCounted[k] = localStorage.getItem(k) || "";
      }
      if (k.startsWith("nsk_manual_team_")){
        payload.manualFlags[k] = safeParseJSON(localStorage.getItem(k) || "{}", {});
      }
    }

    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "nsk-lag-backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    document.getElementById("importMsg").innerHTML = "<span class='ok'>‚úî Export klar</span>";
  }

  function wireImport(){
    const fileInput = document.getElementById("importFile");
    fileInput.addEventListener("change", async ()=>{
      const f = fileInput.files && fileInput.files[0];
      if (!f) return;
      try{
        const txt = await f.text();
        const data = JSON.parse(txt);

        if (Array.isArray(data.players) || Array.isArray(data.coaches)){
          saveRegister(Array.isArray(data.players)?data.players:[], Array.isArray(data.coaches)?data.coaches:[]);
        }
        if (data.matchCounts && typeof data.matchCounts === "object"){
          for (const [k,v] of Object.entries(data.matchCounts)){
            if (k.startsWith("nsk_matchCount_team_")) localStorage.setItem(k, String(v));
          }
        }
        if (data.teamCoaches && typeof data.teamCoaches === "object"){
          for (const [k,v] of Object.entries(data.teamCoaches)){
            if (k.startsWith("nsk_team_coaches_team_")) localStorage.setItem(k, JSON.stringify(Array.isArray(v)?v:[]));
          }
        }
        if (data.states && typeof data.states === "object"){
          for (const [k,v] of Object.entries(data.states)){
            if (k.startsWith("nsk_state_")) localStorage.setItem(k, JSON.stringify(v));
          }
        }
        if (data.goalieStats && typeof data.goalieStats === "object"){
          for (const [k,v] of Object.entries(data.goalieStats)){
            if (k.startsWith("nsk_goalie_stats_team_")) localStorage.setItem(k, JSON.stringify(v || {}));
          }
        }
        if (data.goalieCounted && typeof data.goalieCounted === "object"){
          for (const [k,v] of Object.entries(data.goalieCounted)){
            if (k.startsWith("nsk_goalie_counted_team_")) localStorage.setItem(k, String(v || ""));
          }
        }
        if (data.manualFlags && typeof data.manualFlags === "object"){
          for (const [k,v] of Object.entries(data.manualFlags)){
            if (k.startsWith("nsk_manual_team_")) localStorage.setItem(k, JSON.stringify(v || {}));
          }
        }
        if (data.pdfPrefs && typeof data.pdfPrefs === "object"){
          if (data.pdfPrefs[PDF_PREF_KEY]) localStorage.setItem(PDF_PREF_KEY, String(data.pdfPrefs[PDF_PREF_KEY]));
        }

        refreshAllDropdownsAndPlayers();
        applyMatchCount();
        applyTeamCoachesToUI();
        loadState();
        renderAll();
        document.getElementById("importMsg").innerHTML = "<span class='ok'>‚úî Import klar</span>";

        if (document.getElementById("goalieStatsModal").style.display === "block"){
          renderGoalieStats();
        }
      } catch(e){
        document.getElementById("importMsg").innerHTML = "<span class='error'>‚úñ Import misslyckades</span>";
      } finally {
        fileInput.value = "";
      }
    });
  }

  // ----------------------------
  // Init dropdowns
  // ----------------------------
  function initSettingsDropdowns(){
    // Plan: val 1-4 (INTE "Plan 1" etc)
    const arena = document.getElementById("arena");
    arena.innerHTML = "";
    for (let i=1; i<=4; i++){
      const o = document.createElement("option");
      o.value = String(i);
      o.textContent = String(i);
      arena.appendChild(o);
    }
    arena.value = "1";

    // teamSize 1-25 (default 10)
    const teamSize = document.getElementById("teamSize");
    teamSize.innerHTML = "";
    for (let i=1; i<=25; i++){
      const o = document.createElement("option");
      o.value = String(i);
      o.textContent = String(i);
      teamSize.appendChild(o);
    }
    teamSize.value = "10";

    // onCourt 3-5 (default 3)
    const onCourt = document.getElementById("onCourt");
    onCourt.innerHTML = "";
    [3,4,5].forEach(n=>{
      const o = document.createElement("option");
      o.value = String(n);
      o.textContent = String(n);
      onCourt.appendChild(o);
    });
    onCourt.value = "3";

    // Perioder 1-3 default 1
    const periodsCount = document.getElementById("periodsCount");
    periodsCount.innerHTML = "";
    [1,2,3].forEach(n=>{
      const o = document.createElement("option");
      o.value = String(n);
      o.textContent = String(n);
      periodsCount.appendChild(o);
    });
    periodsCount.value = "1";

    // Periodtid 8-20 default 15
    const period = document.getElementById("periodMin");
    period.innerHTML = "";
    for (let m=8; m<=20; m++){
      const o = document.createElement("option");
      o.value = String(m);
      o.textContent = String(m);
      period.appendChild(o);
    }
    period.value = "15";

    // Bytestid 30-180 default 90
    const shift = document.getElementById("shiftSec");
    shift.innerHTML = "";
    for (let s=30; s<=180; s+=5){
      const o = document.createElement("option");
      o.value = String(s);
      o.textContent = String(s);
      shift.appendChild(o);
    }
    shift.value = "90";
  }

  // ----------------------------
  // Init + events
  // ----------------------------
  function init(){
    applyPageStyle();
    initSettingsDropdowns();
    wireImport();

    fillMatchCountDropdown();
    applyMatchCount();

    // seed goalie stats om de inte finns (alla lag)
    for (let t=1; t<=3; t++) ensureGoalieStatsSeeded(String(t));

    refreshAllDropdownsAndPlayers();
    loadState();
    applyTeamCoachesToUI();

    // autosave match meta + settings (ej goalie h√§r)
    const ids = [
      "matchDate","matchTime","opponent","arena",
      "onCourt","periodsCount","periodMin","shiftSec"
    ];
    ids.forEach(id=>{
      const el = document.getElementById(id);
      el.addEventListener("change", ()=>{ saveState(); renderAll(); });
      el.addEventListener("input", ()=>{ saveState(); });
    });

    // goalie: spara + statistik + (match1 -> √∂vriga)
    const goalieEl = document.getElementById("goalie");
    goalieEl.addEventListener("change", ()=>{
      const teamNo = document.getElementById("teamSelect").value || "1";
      const matchNo = document.getElementById("matchNo").value || "1";

      if (parseInt(matchNo,10) > 1) markManual(teamNo, matchNo, "goalie");

      saveState();
      updateGoalieStatsForMatch(teamNo, matchNo, goalieEl.value || "");

      if (parseInt(matchNo,10) === 1){
        propagateFromMatch1(teamNo);
      }

      if (document.getElementById("goalieStatsModal").style.display === "block"){
        renderGoalieStats();
      }

      renderAll();
    });

    // team size changes how many player selects exist
    document.getElementById("teamSize").addEventListener("change", ()=>{
      const teamNo = document.getElementById("teamSelect").value || "1";
      const matchNo = document.getElementById("matchNo").value || "1";

      const newN = parseInt(document.getElementById("teamSize").value || "10", 10);
      const st = getFormState();
      st.teamSize = String(newN);
      renderPlayerSelectors(newN, st.players || []);

      if (parseInt(matchNo,10) > 1) markManual(teamNo, matchNo, "players");

      saveState();

      if (parseInt(matchNo,10) === 1){
        propagateFromMatch1(teamNo);
      }

      renderAll();
    });

    // coach multiselect: save per TEAM only
    document.getElementById("coach").addEventListener("change", ()=>{
      saveTeamCoaches(selectedValues(document.getElementById("coach")));
      renderAll();
    });

    // antal matcher per lag
    document.getElementById("matchCount").addEventListener("change", ()=>{
      const n = parseInt(document.getElementById("matchCount").value || "4", 10);
      saveMatchCount(n);
      applyMatchCount();

      // om match 1 finns: se till att nya matcher defaultar
      const teamNo = document.getElementById("teamSelect").value || "1";
      propagateFromMatch1(teamNo);

      loadState();
      renderAll();
    });

    // byt lag
    document.getElementById("teamSelect").addEventListener("change", ()=>{
      applyMatchCount();
      refreshAllDropdownsAndPlayers();
      applyTeamCoachesToUI();
      loadState();
      renderAll();

      if (document.getElementById("goalieStatsModal").style.display === "block"){
        renderGoalieStats();
      }
    });

    // byt match
    document.getElementById("matchNo").addEventListener("change", ()=>{
      loadState();
      renderAll();
    });

    // modal close on outside click
    document.getElementById("registerModal").addEventListener("click", (e)=>{
      if (e.target.id === "registerModal") closeRegister();
    });
    document.getElementById("goalieStatsModal").addEventListener("click", (e)=>{
      if (e.target.id === "goalieStatsModal") closeGoalieStats();
    });
    document.getElementById("pdfModal").addEventListener("click", (e)=>{
      if (e.target.id === "pdfModal") closePdfModal();
    });

    // pdf size selection persists
    document.getElementById("pdfSize").addEventListener("change", ()=>{
      savePdfSize(document.getElementById("pdfSize").value || "A4");
      applyPageStyle();
    });

    renderAll();
  }

  window.addEventListener("load", init);
</script>

</body>
</html>